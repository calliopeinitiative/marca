<?php

namespace Marca\CourseBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * ProjectRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProjectRepository extends EntityRepository
{
  public function findProjectsByCourse($course, $resource)
    {
        $parents = $this->getEntityManager()
            ->createQuery('SELECT p.id from MarcaCourseBundle:Course c JOIN c.parents p WHERE c.id = ?1')->setParameter('1',$course)->getResult();
        if ($parents) {
        return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE (p.course = ?1 OR (p.course in (?3) AND p.resource= true)) AND p.resource = ?2 ORDER BY p.course,p.sortOrder')->setParameter('1',$course)->setParameter('2',$resource)->setParameter('3',$parents)->getResult();
        } else {
            return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE p.course = ?1 AND p.resource = ?2 ORDER BY p.sortOrder')->setParameter('1',$course)->setParameter('2',$resource)->getResult();
        }
        
        }

        
  public function findProjectByCourse($course, $resource)
    {
            return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE p.course = ?1 AND p.resource = ?2')->setParameter('1',$course)->setParameter('2',$resource)->setMaxResults(1)->getSingleResult();
        }
        
        
  public function findParentProjects($course)
    {   $parents = $this->getEntityManager()
            ->createQuery('SELECT p.id from MarcaCourseBundle:Course c JOIN c.parents p WHERE c.id = ?1')->setParameter('1',$course)->getResult();
    if ($parents)   {
    return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE p.course in (?1) ORDER BY p.sortOrder')->setParameter('1',$parents)->getResult();
    }
    
    }

    public function findProjectsInSortOrder($course)
    {
        return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE p.course = ?1 AND p.resource = false ORDER BY p.sortOrder')->setParameter('1',$course)->getResult();
    }

    public function findResourcesInSortOrder($course)
    {
        return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE p.course = ?1 AND p.resource = true ORDER BY p.sortOrder')->setParameter('1',$course)->getResult();
    }

   
    public function findProjectBySortOrder($course, $sortOrder)
    {
        return $this->getEntityManager()
            ->createQuery('SELECT p from MarcaCourseBundle:Project p WHERE p.course = ?1 AND p.sortOrder = ?2')->setParameter('1',$course)->setParameter('2',$sortOrder)->getSingleResult();
    }
    
}
