{# Marca/DocBundle/Resources/views/Doc/edit.html.twig #}

{% extends 'MarcaDocBundle::layout.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/marcahome/ckeditor/ckeditor_tools.js') }}"></script>
    <script language="javascript">
        $(document).ready(function () {
            var editorheight = $(document).height() * .98;
            $('#saving_alert').toggle();
            $('#doc-tools').css('height', function (index) {
                return $(window).height() * .98;
            });
            var editor = CKEDITOR.instances.marca_docbundle_doctype_body;
            var autoSave = setInterval(function () {
                var buffer = editor.checkDirty();
                if (buffer == 1) {
                    editor.resetDirty();
                    var body = editor.getData();
                    $.post("{{ course_path('doc_ajax', { 'id': doc.id }) }}", {docBody: body}, function (data) {
                    });
                    $('#saving_alert').fadeIn();
                    $('#saving_alert').delay(2000).fadeOut();
                }
            }, 15000);
            $(function () {
                var rubric = CKEDITOR.dom.element.createFromHtml('<div class="eDoc_rubric"><hr/>{% spaceless %}{% for page in pages %}{{ page.body|raw }}{% endfor %}{% endspaceless %}</div>');
                $('#insert_rubric').click(function () {
                    editor.insertElement(rubric);
                });
            });
            editor.on('instanceReady', function () {
                editor.resize('80%', editorheight);
            });
            $('#toggle-tools').click(function () {
                $('#doc-tools').toggleClass('hide');
                $('#doc-edit').toggleClass('col-sm-offset-2');
            });
            $('#notice').click(function () {
                $(this).toggleClass('hide');
            });
            {% include 'MarcaDocBundle:Doc:js.html.twig' %}
        });
    </script>
{% endblock %}

{% block content %}
    <div class="col-sm-12 center" style="margin-top: -70px">
        <form id="doc_form" class=""
              action="{{ course_path('doc_update', { 'id': doc.id,'view': app.request.get('view') }) }}"
              method="post" {{ form_enctype(edit_form) }}>


            <div class="col-sm-12 center">
                {% for flashMessage in app.session.flashbag.get('notice') %}
                    <div id="notice" class="col-sm-12 alert alert-info">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        {{ flashMessage }}
                    </div>
                {% endfor %}
                <div id='doc-edit' class="col-sm-8">
                    {{ form_errors(edit_form) }}
                    {{ form_errors(edit_form.body) }}
                    {{ form_widget(edit_form.body) }}
                    {{ form_rest(edit_form) }}
                </div>

                {# Doc tools #}
                <div id='doc-tools' class="col-sm-4">
                    {% include 'MarcaDocBundle:Doc:doctools.html.twig' %}
                </div>

            </div>
        </form>
    </div>

{% endblock %}
