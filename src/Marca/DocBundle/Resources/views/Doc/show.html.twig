{# Marca/DocBundle/Resources/views/Doc/show.html.twig #}


{% extends 'MarcaDocBundle::layout.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script language="javascript">
        $(document).ready(function()
        {
            var numNotes = $('.eDoc_note').length;
            if (numNotes > 0)
            {$('.eDoc_note').each(function(index) {
                note_index = index + 1;
                var note_number = '<span class="blue">' + note_index + '</span>';
                var note = '<div class="cell divider clear">'+ note_number + $(this).html() + '</div>';
                $('#notes_container').append(note);
            });
            }
            else
            {var note = '<div class="cell divider clear">There are no notes in this document.</div>';
                $('#notes_container').append(note);
            };

            $('.eDoc_highlight').each(function(index) {
                var span_number = index + 1;
                var span_append = '<span class="hide eDoc_super">' + span_number + '</span>';
                $(this).append(span_append);
            });

            $('.markup').mouseover(function (){
                var id = "[data-id='" + $(this).attr('data-id') + "']";
                $('.popover').hide();$(id).show();
            });

            $('.popover-close, .doc-body').click(function(){
                $('.popover').hide();
            });

            $('#close_window').click(function(){
                window.close();
            });

            $('#new_saveas').click(function(){
                $('#file_modal').load('{{ course_path('file_new_modal', { 'resource' : '0', 'tag' : '0', 'type': 'saveas', 'fileid': file.id }) }}');
                $('#file_modal').modal();
            });

            var txt = $('.doc-body').text();
            var count = txt.trim().replace(/\s+/gi, ' ').split(' ').length;
            $("#word-count").text(count);


            $('#doc-display').css('height', function(index) {
                return $(window).height()* .80;
            });

            $('#doctools').css('height', function(index) {
                return $(window).height() * .80;
            });

        });
    </script>
{% endblock %}

{% block content %} 
<div class="col-md-12 center">
<a name="skip"></a>
<div class="panel panel-default">
    <div class="panel-heading">
        <h1 class="doc-header">{{file.name}}</h1>

        {# Created {{doc.created|date('M d Y, g:ia')}} / Updated {{doc.updated|date('M d Y, g:ia')}} / Word count: <span id="word-count"></span> #}
        <div class="btn-group btn-group-sm pull-right">
            {% if app.request.get('_route') != 'file_view_odt' %}
                {% if doc.isOwner(app.user.username) %}<a title="Edit this document" class="btn btn-primary " href="{{ course_path('doc_edit', { 'id': doc.id,'view': app.request.get('view') }) }}">Edit</a> {% endif %}

                {# Don't show Review button if it is a review or a Resource #}
                {% if file.reviewed|length == 0 and file.project.resource != 'true' %}
                    <a title="Create a copy of this document for peer review" id="new_review" class="btn btn-default " href="{{ course_path('file_new_modal', { 'resource' : '0', 'tag' : '3', 'type': 'review', 'fileid': file.id }) }}">Peer Review</a>
                    {% if role == 2 %}
                        <a title="Create a copy of this document for peer review" id="new_grade" class="btn btn-default " href="{{ course_path('file_new_modal', { 'resource' : '0', 'tag' : '3', 'type': 'instr_review', 'fileid': file.id }) }}">Instructor Review</a>
                    {% endif %}
                {% endif %}

                {% if doc.isOwner(app.user.username) or file.project.resource == 'true' %}
                    <a title="Create a copy of this document" id="new_saveas" class="btn btn-default " href="javascript:void(0)">SaveAs</a>
                {% endif %}
                <a title="Print this document" class="btn btn-default " href="{{ course_path('doc_pdf', { 'id': doc.id }) }}">Printable PDF</a>
            {% endif %}

            {% if app.request.get('view') == 'window' %}
                <a title="Close the current window or tab" id="close_window"  class="btn btn-default " href="javascript:void(0);">Close</a>
            {% elseif file.project.resource == 'true' %}
                <a  title="Close this document" class="btn btn-default " href="{{ course_path('file_list', { 'project': 'recent', 'scope': 'all', 'user': '0','resource': '1', 'tag': '0', 'userid': '0' }) }}">Close</a>
            {% else %}
                {% if app.session.get('referrer')%}
                    <a title="Close this document" class="btn btn-default " href="{{app.session.get('referrer')}} ">Close</a>
                {%else%}
                    <a title="Close this document" class="btn btn-default " href="{{ course_path('file_list', { 'project': 'recent', 'scope': 'mine', 'user': '0', 'resource': '0', 'tag': '0', 'userid': '0' }) }}">Close</a>
                {%endif%}
            {% endif %}
        </div>


    </div>


{# Doc display #}
<div class="panel-body ">

<div id='doc-display' class="col-md-8 well">
<div class="doc-body">
{{ doc.body|raw }}     
</div>
               
</div>
 
{# Doc tools #}        
<div class="col-md-4" id="doctools">
{% if app.request.get('_route') != 'file_view_odt' %}
    <div class="panel-group" id="accordion">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                        Info
                    </a>
                </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in">
                <div class="panel-body">
                    <dl>
                        <dt>Author</dt>
                        <dd>{{ file.user.firstname }} {{ file.user.lastname }}</dd>
                        <dt>Document</dt>
                        <dd>{{ file.name }}</dd>
                        <dt>Updated</dt>
                        <dd>{{ file.updated|date('m/d/y, g:i a') }}</dd>
                        <dt>Created</dt>
                        <dd>{{ file.created|date('m/d/y, g:i a') }}</dd>
                        <dt>Word Count</dt>
                        <dd><span id="word-count"></span> words approx.</dd>
                    </dl>
                    <strong>Labels</strong>
                    {% for tag in file.tag %}<span class="label {{ tag.color }}">{{ tag.name }}</span>{% endfor %}
                    {% if file.access==1 %} <span class="label label-success margin-left">Shared</span>
                    {% elseif file.access==0 %}<span class="label label-success margin-left">Private</span>
                    {% endif %}
                    {% if file.portfolio|length !=0 %} <span class="label label-info">Portfolio</span>{% endif %}
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="$('#notes_container').toggle();$('.eDoc_note').toggle();$('.eDoc_super').toggle();" data-toggle="tab">Notes
                    </a>
                </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse">
                <div class="panel-body">
                    <div class="tab-pane fade" id="docNotes">
                        <div id='notes_container' class='pad'>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
                        Feedback
                    </a>
                </h4>
            </div>
            <div id="collapseThree" class="panel-collapse collapse">
                <div class="panel-body">
                    {# Responses #}
                    <div class="">
                        <a class="btn btn-default " href="{{ course_path('response_new', { 'sourceid': doc.id, 'source': 'doc_show' ,'view': app.request.get('view'),'userid': doc.file.user.id }) }}">Offer Feedback</a>
                    </div>
                    {% for response in file.responses %}
                        <div class="well-header" >{{ response.user.firstname}} {{ response.user.lastname}} says:
                            {% if response.isOwner(app.user.username) %}
                                <a class="btn btn-default btn-xs pull-right" href="{{ course_path('response_edit', { 'id': response.id,'sourceid': doc.id, 'source': 'doc_show','view': app.request.get('view'),'userid': doc.file.user.id  }) }}">Edit</a>
                            {% endif %}
                        </div>
                        <div class="pad">
                            {{ response.body|raw }}
                        </div>

                    {% else %}
                        <div class="pad">No one has has offered feedback.</div>
                    {% endfor %}
                </div>
            </div>
            </div>
</div>
</div>

</div>
    {% endif %}
</div>
{# end of Doc tools #}

    {# Markup #}
    {% for markup in markup %}
        <div data-id='{{ markup.id }}' id='{{ markup.value }}' class='popover hide'>
            <button type="button" class="close popover-close" aria-hidden="true">Ã—</button>
            <span  class="label {{ markup.color }} " style='color:black;'>{{ markup.name }}</span>
            <br/>
            {{ markup.mouseover|raw }}
            {% if markup.url != '' or markup.url is not null %}<a href="{{ markup.url }}" target="_blank">{{ markup.linktext }}</a>{% endif %}
        </div>
    {% endfor %}


</div>

{# Modal #}
<div id="file_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
</div>
{% endblock %}
