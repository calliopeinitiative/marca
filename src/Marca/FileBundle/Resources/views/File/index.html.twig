{# Marca/FileBundle/Resources/views/File/index.html.twig #}

{% extends 'MarcaFileBundle::layout.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <!-- tablesorter plugin -->
    <script src="{{ asset('bundles/marcahome/js/jquery.tablesorter.min.js') }}"></script>
    <!-- tablesorter widget file - loaded after the plugin -->
    <script src="{{ asset('bundles/marcahome/js/jquery.tablesorter.widgets.min.js') }}"></script>
    <script language="javascript">
        $(document).ready(function() {
            $('.modal-body').css('max-height', function(index) {
                return $(window).height() * .90;
            });
            {% for file in files%}
            $('.edit_{{file.id}}').click(function(){
                $('#file_modal').load('{{ course_path('file_edit_modal', { 'id': file.id, 'resource': app.request.get('resource'), 'tag': app.request.get('tag') }) }}').modal();
            });
            $('#upload_{{file.id}}').click(function(){
                $('#file_modal').load('{{ course_path('review_upload', { 'resource' : '0', 'tag' : '3', 'fileid': file.id }) }}').modal();
            });
            $('#file_show_{{file.id}}').click(function(){
                $('#file_modal').load('{{ course_path('file_show_modal', { 'id': file.id, 'resource': app.request.get('resource'),'source':'edit_modal'}) }}').modal();
            });
            {% for file in file.reviews%}
            $('.edit_{{file.id}}').click(function(){
                $('#file_modal').load('{{ course_path('file_edit_modal', { 'id': file.id, 'resource': app.request.get('resource'), 'tag': app.request.get('tag') }) }}').modal();
            });
            $('#file_show_{{file.id}}').click(function(){
                $('#file_modal').load('{{ course_path('file_show_modal', { 'id': file.id, 'resource': app.request.get('resource'),'source':'edit_modal'}) }}').modal();
            });
            {% endfor %}
            {% endfor %}
            $('.file-wrapper').css('max-height', function(index) {
                return $(window).height()* .88;
            });
            $.extend($.tablesorter.themes.bootstrap, {
                    table      : 'table',
                    header     : 'bootstrap-header', // give the header a gradient background
                    footerRow  : '',
                    footerCells: '',
                    icons      : '', // add "icon-white" to make them white; this icon class is added to the <i> in the header
                    sortNone   : 'glyphicon glyphicon-sort',
                    sortAsc    : 'glyphicon glyphicon-arrow-up',     // includes classes for Bootstrap v2 & v3
                    sortDesc   : 'glyphicon glyphicon-arrow-down', // includes classes for Bootstrap v2 & v3
                    active     : '', // applied when column is sorted
                    hover      : '', // use custom css here - bootstrap class may not override it
                    filterRow  : '', // filter row class
                    even       : '', // odd row zebra striping
                    odd        : ''  // even row zebra striping
                });
                // call the tablesorter plugin and apply the uitheme widget
                $("table").tablesorter({
                    theme : "bootstrap",
                    widthFixed: true,
                    headerTemplate : '{content} {icon}', // new in v2.7. Needed to add the bootstrap icon!
                    widgets : [ "uitheme"]
                });
            $( "tr" ).hover(
                    function() {
                        $(".file-menu").hide();$( ".file-menu", this ).toggle();
                    }
            );
            $( "i" ).hover(
                    function() {
                        $(".tablesorter-icon").show();$( ".tablesorter-icon", this ).toggle();
                    }
            );
            $('.file_name').bind('focus', function(){ $(".file-menu").hide();$(this).parent().children("div").children("div").toggle(); });
            var count_hidden = $('#file_list tr.hidden').length
            var count_displayed = $('#file_list tr').length -2;
            var count = count_displayed - count_hidden;
            var count_text = '';
            if (count > 1) {count_text = ' ' + count + ' files found';$('li.file_count').append(count_text);}


        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link type="text/css" rel="stylesheet" href="{{ asset('bundles/marcahome/css/theme.bootstrap.css') }}">
{% endblock %}

{% block content %}
    {# Breadcrumbs #}
    {% if app.request.get('project') == 'recent' and app.request.get('resource')!=0 %}
        {% for flashMessage in app.session.flashbag.get('message') %}
            <div class="alert alert-info pad5 col-sm-11">
                {{ flashMessage }}
            </div>
        {% endfor %}
    {% endif %}

    {% if byuser %}
    <nav class="subnav navbar navbar-default hidden-xs" role="navigation">
        <div class="navbar-header col-sm-6">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#" title="Files by {{ byuser.firstname|title }} {{ byuser.lastname|title }}"><div class="panel-title small">Files by {{ byuser.firstname|title }} {{ byuser.lastname|title }}</div></a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav pull-right">
                {% for roll in roll %}
                    {% if loop.index == app.request.get('user') + 1 and app.request.get('tag')!='3' %}
                        <li><a data-index="{{loop.index}}" data-id='{{roll.user.id}}' data-project='{{app.request.get('project')}}' data-tag='{{app.request.get('tag')}}' href="{{ course_path('file_list', { 'project': app.request.get('project'), 'scope': 'byuser', 'user': loop.index,'resource': app.request.get('resource'), 'tag': app.request.get('tag'), 'userid': roll.user.id }) }}">{{roll.firstname|title}} {{roll.lastname|title}} &gt;</a></li>
                    {% endif %}
                    {% if loop.index == app.request.get('user') - 1 and app.request.get('tag')!='3' %}
                        <li><a class='' data-index="{{loop.index}}" data-id='{{roll.user.id}}' data-project='{{app.request.get('project')}}' data-tag='{{app.request.get('tag')}}' href="{{ course_path('file_list', { 'project': app.request.get('project'), 'scope': 'byuser', 'user': loop.index,'resource': app.request.get('resource'), 'tag': app.request.get('tag'), 'userid': roll.user.id }) }}">&lt; {{roll.firstname|title}} {{roll.lastname|title}}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </nav>
    {% endif %}

    <div class="file-wrapper well">

        <table id="file_list" class="col-sm-12 table">
            <thead>
            <tr class="file">
                <th><span>Title</span></th>
                <th>Author</th>
                <th class="hidden-xs">{% if app.request.get('resource')=='1' %}Unit{% else %}Folder{% endif %}</th>
                <th class="hidden-xs">Labels</th>
                <th>Modified</th>
            </tr>
            </thead>
            <tbody>
            {% for file in files%}
                {# main list of files #}
                <tr class="file">
                    <td>
                        {# different functions for different file types #}
                        {# doc files #}
                        {% if file.doc %}
                            <a class="file_name" href="{{ course_path('doc_show', { 'id': file.id, 'view': 'app' }) }}" title="View {{ file.name }}" >
                                {{ file.name|slice(0,20) }}{% if file.name|length > 20 %}...{% endif %}
                            </a>
                            <span class="label label-file pull-left" data-toggle="tooltip" title="This an html file ">html</span>
                        {# links #}
                        {% elseif file.url %}
                            <a class="file_name" href="{{ file.url}}" target="_blank" title='This link will open in a new window or tab.'>
                                {{ file.name|slice(0,20) }}{% if file.name|length > 20 %}...{% endif %}
                            </a>
                            <span class="label label-file pull-left" data-toggle="tooltip" title="This a link ">link</span>
                        {# ODT files #}
                        {% elseif file.ext == 'odt' or file.ext == 'ods' or file.ext == 'odp' or file.ext == 'pdf' %}
                            <a class="file_name" href="{{ course_path('file_view', { 'id': file.id, 'view': 'app' }) }}" title="View {{ file.name }}" >
                                {{ file.name|slice(0,20) }}{% if file.name|length > 20 %}...{% endif %}
                            </a>
                            <span class="label label-file pull-left" data-toggle="tooltip" title="This an {{ file.ext }} file ">{{ file.ext }}</span>
                        {% else %}
                            <a class="file_name" href="{{ course_path('file_get', { 'id': file.id}) }}" title="View {{ file.name }}" >
                                {{ file.name|slice(0,20) }}{% if file.name|length > 20 %}...{% endif %}
                            </a>
                            <span class="label label-file pull-left" data-toggle="tooltip" title="This an {{ file.ext }} file ">{{ file.ext }}</span>
                        {% endif %}
                        {% if file.access==1 %} <span class="label label-success pull-right margin-left" title="This file is shared with the rest of the class.">Shared</span>{% endif %}
                        {% if file.portfolio|length !=0 %} <span class="label label-info pull-right margin-left" title="This file is in your portfolio.  You must remove files from the portfolio before you can delete them.">Portfolio</span>{% endif %}
                        {% if file.feedback|length != 0 %} <span class="label label-primary pull-right margin-left" title="Someone has offered feedback on this file.">Feedback</span>{% endif %}
                        <div class="hidden-xs">
                        <div class="file-menu">
                            {% if file.isOwner(app.user.username) %}
                            <a  class="edit_{{file.id}}" href="javascript:void(0);" title="Edit the setting for this file." >Settings</a>
                            {% endif%}
                            {% if file.ext == 'odt' or file.ext == 'ods' or file.ext == 'odp' or file.ext == 'pdf' %}
                                <a class="file_name" href="{{ course_path('file_get', { 'id': file.id}) }}" title="Download {{ file.name }}" >Download</a>
                            {% endif %}
                            {% if app.request.get('resource')=='0' and (file.doc or file.ext == 'odt') %}
                                <a class="" title="Create a copy of this document for review" id="new_grade_{{file.id}}" href="{{ course_path('file_new_modal', { 'resource' : '0', 'tag' : '3', 'type': 'review', 'fileid': file.id }) }}">Create Review</a>
                            {% endif %}
                            {% if app.request.get('resource')=='0' %}
                                <a class="" title="Upload a file for review" id="upload_{{file.id}}" href="javascript:void(0);">Upload Review</a>
                            {% endif %}
                            {% if file.isOwner(app.user.username) and file.portfolio|length == 0 and file.reviews|length == 0 and file.feedback|length == 0 %}
                                <a class="delete disabled" id='file_show_{{file.id}}' href='javascript:void(0);' title="Delete this file.">Delete</a>
                            {% elseif file.isOwner(app.user.username) and file.portfolio|length != 0 %}Files in the Portfolio can not be deleted.
                            {% elseif file.isOwner(app.user.username) and file.reviews|length != 0 %}Files that have reviews can not be deleted.
                            {% elseif file.isOwner(app.user.username) and file.feedback|length != 0 %}Files that have feedback can not be deleted.
                            {% endif%}
                        </div>
                        </div>
                    </td>

                    <td>{% if file.isOwner(app.user.username) %}me{% else %}{{ file.user.firstname|title }} {{ file.user.lastname|title }}{% endif %}</td>
                    <td class="hidden-xs">{% if app.request.get('project')=='recent' %}{% if app.request.get('resource')=='1' %}{{ file.project.course.name }}: {% endif %}{{ file.project.name }}{% endif %}</td>
                    <td class="labels hidden-xs">{% if file.access!=1 and file.portfolio|length ==0 and file.tag |length ==0%}&mdash;{% endif %}
                        {% for tag in file.tag %}<span class="label label-default margin-right" style="background-color: {{ tag.color }};">{{ tag.name }}</span>{% endfor %}</td>
                    <td>{% if app.request.get('resource')=='0' %}{{ file.updated|date('m/d/y, g:i a') }}{% endif %}</td>
                </tr>
                    {% for review in file.reviews%}
                        {% if (file.isOwner(app.user.username) and review.access!=2) or review.isOwner(app.user.username) or review.access==1 or role==2 %}
                            <tr class="review">
                                <td>
                                    {# different functions for different file types #}
                                    {# doc files #}
                                    {% if review.doc %}
                                        <span class="label label-file" title="This an html file ">html</span>
                                        <a class="file_name" href="{{ course_path('doc_show', { 'id': review.id, 'view': 'app' }) }}"  title="View {{ review.name }}">
                                            Review of <i>{{ review.reviewed.name|slice(0,10) }}{% if file.name|length > 10 %}...{% endif %}</i> for {{ review.reviewed.user.firstname }} {{ review.reviewed.user.lastname }}
                                            <span class="glyphicon glyphicon-comment" style="color:#888;" title="Review"></span>
                                        </a>
                                        {# links #}
                                    {% elseif review.url %}
                                        <span class="label label-file" title="This a link ">link</span>
                                        <a class="file_name" href="{{ review.url}}" target="_blank" title='This link will open in a new window or tab.'>
                                            Review of <i>{{ review.reviewed.name|slice(0,10) }}{% if file.name|length > 10 %}...{% endif %}</i> for {{ review.reviewed.user.firstname }} {{ review.reviewed.user.lastname }}
                                            <span class="glyphicon glyphicon-comment" style="color:#888;" title="Review"></span>
                                        </a>
                                        {# ODT files #}
                                    {% elseif review.ext == 'odt' or review.ext == 'ods' or review.ext == 'odp' or review.ext == 'pdf' %}
                                        <span class="label label-file" title="This an {{ review.ext }} file ">{{ review.ext }}</span>
                                        <a class="file_name" href="{{ course_path('file_view', { 'id': review.id, 'view': 'app' }) }}" title="View {{ review.name }}" >
                                            Review of <i>{{ review.reviewed.name|slice(0,10) }}{% if file.name|length > 10 %}...{% endif %}</i> for {{ review.reviewed.user.firstname }} {{ review.reviewed.user.lastname }}
                                            <span class="glyphicon glyphicon-comment" style="color:#888;" title="Review"></span>
                                        </a>
                                    {% else %}
                                        <span class="label label-file" title="This an {{ review.ext }} file ">{{ review.ext }}</span>
                                        <a class="file_name" href="{{ course_path('file_get', { 'id': review.id}) }}" title="View {{ review.name }}" >
                                            Review of <i>{{ review.reviewed.name|slice(0,10) }}{% if file.name|length > 10 %}...{% endif %}</i> for {{ review.reviewed.user.firstname }} {{ review.reviewed.user.lastname }}
                                            <span class="glyphicon glyphicon-comment" style="color:#888;" title="Review"></span>
                                        </a>
                                    {% endif %}
                                    {% if review.access==1 %} <span class="label label-success pull-right">Shared</span>
                                    {% elseif review.access==2 %} <span title="This review is currently hidden from view." class="label label-default black pull-right">Hidden</span>{% endif %}
                                    {% if review.portfolio|length !=0 %} <span class="label label-info pull-right margin-left" title="This file is in your portfolio.  You must remove files from the portfolio before you can delete them.">Portfolio</span>{% endif %}
                                    <div class="hidden-xs">
                                    <div class="file-menu">
                                        {% if review.isOwner(app.user.username) and review.access!=2 %}<a class='edit_{{review.id}}' href="javascript:void(0);" title="Edit the setting for this file.">Settings</a>{% endif%}
                                        {% if role==2 and review.isOwner(app.user.username) %}<a class='' href="{{ course_path('file_toggle_release', { 'id': review.id }) }}"  title="Instructor reviews can be hidden or released to students.  Click to hide or release.">{% if review.access==2 %}Release{% else %}Hide{% endif %}</a>{% endif%}
                                        {% if review.isOwner(app.user.username) and review.portfolio|length == 0 %}
                                            <a class='delete' id='file_show_{{review.id}}' href='javascript:void(0);'  title="Delete this file.">Delete</a>
                                            {% elseif review.isOwner(app.user.username) and review.portfolio|length != 0 %}Files in the Portfolio can not be deleted.
                                        {% endif%}
                                    </div>
                                    </div>
                                </td>
                                <td>{% if review.isOwner(app.user.username) %}me{% else %}{{ review.user.firstname|title }} {{ review.user.lastname|title }}{% endif %}</td>
                                <td class="hidden-xs"></td>
                                <td class="labels hidden-xs">
                                    {% for tag in review.tag %}<span class="label label-default" style="background-color: {{ tag.color }};">{{ tag.name }}</span>{% endfor %}
                                </td>
                                <td>
                                    {% if app.request.get('resource')=='0' %}{{ review.updated|date('m/d/y, g:i a') }}{% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
            {% else %}
                {% if app.request.get('project') == 'recent' and app.request.get('resource')!=0 %}
                {% else %}
                    <tr><td colspan="5">No files match your request.</td> </tr>
                {% endif %}
            {% endfor %}

            </tbody>
        </table>

        <div class="navigation">
            {{ knp_pagination_render(files) }}
        </div>

    </div>


    {# Modal #}
    <div class="modal fade" id="file_modal" role="dialog" >

    </div><!-- /.modal -->

{% endblock %}

