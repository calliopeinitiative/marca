<?php

namespace Marca\FileBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * FileRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FileRepository extends EntityRepository
{
/**
 * First conditional catches sort order by name, project, tag or updated
 * Second conditional catches Recent Files listing (with no associated project defined so it can be omitted from seach.
 * Sort is not currently working; need to refactor the join
 */
   public function findFilesByProject($project, $user, $scope, $tag, $byuser, $role)
    {
        if($scope == 'all' and $role == 2) {$scopeQuery = ' or f.access = 1 or f.access = 0';}
        elseif($scope == 'all' and $role != 2) {$scopeQuery = ' or f.access = 1';}
        elseif($scope == 'byuser' and $role == 2) {$user = $byuser; $scopeQuery = '';}
        elseif($scope == 'byuser' and $role != 2) {$user = $byuser; $scopeQuery = ' AND f.access = 1';}
        else {$scopeQuery = '';};
        if ($tag != 0) {$tagQuery = '';} else {$tagQuery = ' OR t.id != 0 OR t.id is NULL';}
          return $this->getEntityManager()
            ->createQuery('SELECT f, p, d, t, r, o, b, g FROM MarcaFileBundle:File f JOIN f.project p LEFT JOIN f.doc d LEFT JOIN f.portfolio o  LEFT JOIN f.grade g LEFT JOIN f.tag t LEFT JOIN f.reviews r  LEFT JOIN f.feedback b
                WHERE f.project = ?1 AND f.reviewed IS NULL AND (f.user = ?3'.$scopeQuery.') AND (t.id = ?4'.$tagQuery.') ORDER BY  f.updated DESC')
                ->setParameter('1',$project)->setParameter('3',$user)->setParameter('4',$tag)->getResult();
    }

/**
 * First users files with shared access for portfolio
 */
  public function findFilesForPort($project, $user)
    {

          return $this->getEntityManager()
            ->createQuery('SELECT f, p, d, t, r, o  FROM MarcaFileBundle:File f JOIN f.project p LEFT JOIN f.doc d LEFT JOIN f.portfolio o LEFT JOIN f.tag t LEFT JOIN f.reviews r
                WHERE f.project = ?1 AND f.reviewed IS NULL AND f.user = ?2 AND f.access = 1  ORDER BY  f.name ASC')
                ->setParameter('1',$project)->setParameter('2',$user)->getResult();
    }

    /**
     * check for files for project delete
     */
    public function checkProjectFiles($project, $user)
    {
            return $this->getEntityManager()
                ->createQuery('SELECT f, p  FROM MarcaFileBundle:File f JOIN f.project p WHERE f.project = ?1 AND f.user = ?2')
                ->setParameter('1',$project)->setParameter('2',$user)->getResult();
    }


   public function findReviewFiles ($project, $user, $scope, $byuser, $role)
    {
        if($scope == 'all' and $role == 2) {$scopeQuery = ' or f.access = 1 or f.access = 0';}
        elseif($scope == 'all' and $role != 2) {$scopeQuery = ' or f.access = 1';}
        elseif($scope == 'byuser' and $role == 2) {$user = $byuser; $scopeQuery = '';}
        elseif($scope == 'byuser' and $role != 2) {$user = $byuser; $scopeQuery = ' AND f.access = 1';}
        else {$scopeQuery = '';};
        return $this->getEntityManager()
            ->createQuery('SELECT f, p, d, t, r, o, b, g FROM MarcaFileBundle:File f JOIN f.project p LEFT JOIN f.doc d LEFT JOIN f.portfolio o  LEFT JOIN f.grade g LEFT JOIN f.tag t LEFT JOIN f.reviewed r  LEFT JOIN f.feedback b
                WHERE r.project = ?1 AND f.reviewed IS NOT NULL AND (f.user = ?2'.$scopeQuery.') ORDER BY  f.updated DESC')
            ->setParameter('1',$project)->setParameter('2',$user)->getResult();
   }
    
    public function deleteEdoc($id)
    {
         return $this->getEntityManager()
            ->createQuery('DELETE MarcaFileBundle:File f WHERE f.id = ?1')
                ->setParameter('1',$id)->getResult(); 
    } 
    
    public function countFilesByUser($user, $course)
    {
       return $this->getEntityManager()
               ->createQuery('SELECT f.id from MarcaFileBundle:File f WHERE f.user = ?1 AND f.course = ?2')
               ->setParameters(array('1' => $user, '2' => $course))->getResult();
    } 
    
    public function findHidden($user, $course)
    {
       return $this->getEntityManager()
               ->createQuery('SELECT f from MarcaFileBundle:File f WHERE f.user = ?1 AND f.course = ?2 AND f.access = 2' )
               ->setParameters(array('1' => $user, '2' => $course))->getResult();
    }     
    
    public function countFilesByCourse($course)
    {
       return $this->getEntityManager()
               ->createQuery('SELECT f.id from MarcaFileBundle:File f WHERE f.course = ?1')
               ->setParameters(array('1' => $course))->getResult();
    }

    public function findCoursehomeFiles($course)
    {
        $parents = $this->getEntityManager()
            ->createQuery('SELECT p.id from MarcaCourseBundle:Course c JOIN c.parents p WHERE c.id = ?1')->setParameter('1',$course)->getResult();
        if ($parents) {
            return $this->getEntityManager()
                ->createQuery('SELECT f from MarcaFileBundle:File f JOIN f.project p WHERE (f.course = ?1 OR f.course in (?2)) AND p.coursehome=true AND f.access = 1 ORDER BY  f.name ASC')
                ->setParameters(array('1' =>  $course))->setParameter('2',$parents)->getResult();
        } else {
            return $this->getEntityManager()
                ->createQuery('SELECT f from MarcaFileBundle:File f JOIN f.project p WHERE f.course = ?1 AND p.coursehome=true AND f.access = 1 ORDER BY  f.name ASC')
                ->setParameters(array('1' =>  $course))->getResult();
        }



    }




}